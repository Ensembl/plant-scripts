#!/bin/bash

# Protocol to run the Pan Compara pipeline, based on 
# https://www.ebi.ac.uk/seqdb/confluence/display/EnsGen/Pan+Compara+production
# https://www.ebi.ac.uk/seqdb/confluence/display/EnsGen/Peptide+Compara+pipeline
# https://www.ebi.ac.uk/seqdb/confluence/display/EnsCom/Updating+the+master+database
# https://gist.github.com/gnaamati/e0bb87326293c3cd4e257fc326758044

# by Bruno Contreras Moreira EMBL-EBI 2019

# NOTE: release version of core databases, not ensembl-compara's version
ENS_VERSION=97
EG_VERSION=$(echo $ENS_VERSION-53 | bc)

comparasetup $ENS_VERSION

export LSB_DEFAULTQUEUE=production-rh74

HIVE_CMD=mysql-ens-hive-prod-2-ensrw
HIVE_URL=$(${HIVE_CMD} details url)
MEMBER_URL=${HIVE_URL}$MEMBER_DB

# registry points to master in our prod server
REG_FILE=$p2pancomparareg
MASTER_CMD=mysql-ens-plants-prod-2-ensrw
MASTER_DB=pan_compara_master
MASTER_URL=$($MASTER_CMD details url)$MASTER_DB

PROD_CMD=mysql-eg-pan-prod
PROD_URL=$(${PROD_CMD} details url)ensembl_production
NCBI_URL=$(${PROD_CMD} details url)ncbi_taxonomy

COMPATH=$ENSEMBL_ROOT_DIR/ensembl-compara/scripts/pipeline/
PRODPATH=$ENSAPIPATH/ensembl-prodinf-core/ensembl_prodinf/
HIVEPATH=$ENSEMBL_ROOT_DIR/ensembl-hive/scripts/
TMP_DIR=$comptmp

## current pan species ##############################################

$PROD_CMD $MASTER_DB -e 'select name from genome_db' | \
	tail -n +2 | sort | uniq > current_pan_species.txt

# hack for 97, due to a few bacteria & fungi sp being renamed (see updated_names.txt)
# 1) manually update their genome_db.name and genome_db.strain_name in MASTER_DB
# 2) -> current_pan_species.edited.txt

# new genebuilds / updated species names
echo oryza_sativa > updated_species.txt
echo solanum_lycopersicum >> updated_species.txt
echo physcomitrella_patens >> updated_species.txt
echo chondrus_crispus >> updated_species.txt
cat updated_names.txt >> updated_species.txt

# new species
echo marchantia_polymorpha > new_species.txt
echo brachypodium_distachyon >> new_species.txt

# get list of core dbs for Pan species
csv_species=`perl -ne 's/(\w+)/"$1",/g; print' current_pan_species.edited.txt`

standaloneJob.pl Bio::EnsEMBL::Production::Pipeline::Common::DbFactory \
	--input_id "{ 'species' => [ $csv_species ] }" --reg_conf $pancomparareg \
	-debug 1 &> current_pan_dbs.log

perl -lne 'if(/dbname" => "(\S+?)"/){ print $1 }' current_pan_dbs.log > current_pan_dbs.txt

wc current_pan_dbs.txt
#66

## copy those core dbs to our production server ###################################

TARGET_SERVER=$(${MASTER_CMD} details url)

# comment as needed
SOURCE_SERVER=$(mysql-ens-sta-1 details url)
ENDPOINT=http://ens-prod-1.ebi.ac.uk:8000/dbcopy/

SOURCE_SERVER=$(mysql-ens-sta-3 details url)
SOURCE_SERVER=$(mysql-ens-sta-4 details url)
ENDPOINT=http://eg-prod-01.ebi.ac.uk:7000/dbcopy/ 

for db in $(cat current_pan_dbs.txt);
	do $PRODPATH/db_copy_client.py --action submit --uri ${ENDPOINT} \
		--source_db_uri "${SOURCE_SERVER}${db}" --target_db_uri "${TARGET_SERVER}${db}";
done

# check dbs were copied
$MASTER_CMD -e "show databases" | grep _97_ | wc
#66

## copy cores of new species to our production server #############################

# Copy from mysql://ensro@mysql-ens-sta-3:4160/marchantia_polymorpha_core_44_97_1 to 
# 	mysql://ensrw:scr1b3d3@mysql-ens-plants-prod-2:4208/marchantia_polymorpha_core_44_97_1 is successful

# Copy from mysql://ensro@mysql-ens-sta-3:4160/brachypodium_distachyon_core_44_97_4 to 
#	mysql://ensrw:scr1b3d3@mysql-ens-plants-prod-2:4208/brachypodium_distachyon_core_44_97_4 is successful

$MASTER_CMD -e "show databases" | grep _97_ | wc
#68

## copy pan_compara_master to prod server ######################################

# Copy from mysql://ensro@mysql-eg-pan-prod:4276/pan_compara_master to 
# 	mysql://ensrw:scr1b3d3@mysql-ens-plants-prod-2:4208/pan_compara_master is successful

# check schema and update if needed 
$MASTER_CMD $MASTER_DB -e "select meta_value from meta where meta_key='schema_version'"
# 94

# apply sequentially patches from /homes/bcontreras/devel/compara/97/ensembl-compara/sql
# some might fail due to Pan being slightly different (MMuffato)
patch_94_95_a.sql
#patch_94_95_b.sql failed
patch_94_95_c.sql
#patch_94_95_d.sql failed
patch_95_96_a.sql

## update genomes in pan_compara_master ###########################################

perl $COMPATH/update_genome.pl \
  --reg_conf $REG_FILE \
  --compara $MASTER_URL \
  --release $ENS_VERSION \
  --force 1 \
  --file_of_production_names new_species.txt

perl $COMPATH/update_genome.pl \
  --reg_conf $REG_FILE \
  --compara $MASTER_URL \
  --release $ENS_VERSION \
  --force 1 \
  --file_of_production_names updated_species.txt

perl $COMPATH/update_genome.pl \
  --reg_conf $REG_FILE \
  --compara $MASTER_URL \
  --release $ENS_VERSION \
  --force 1 \
  --file_of_production_names metadata_updated_species.txt

# get full species names as used in $MASTER_DB
$MASTER_CMD $MASTER_DB -e "select name from genome_db where last_release is NULL" | \
	tail -n +2 | grep -v -f removed_species.txt > all_species.txt

# creae a new pan collection of genomes
perl $COMPATH/edit_collection.pl --reg_conf $REG_FILE --compara $MASTER_URL \
	--collection pan --file all_species.txt --new --release 97

# ... there is a difference in the software release (97) and the database release (96)...
# Stored: SpeciesSet dbID=701065 "collection-pan"', 190 genome_dbs [current] -> before excluding removed_species.txt
# Stored: SpeciesSet dbID=702192 "collection-pan"', 187 genome_dbs [current]

## Gene tree and homology configuration ##############################################

# Once the species have been defined, we need to create one method_link_species_set (MLSS) for the gene tree, 
# orthology MLSSs for each pair of species with a division & paralogy MLSSs for each species within a division

# Orthologs
perl $COMPATH/create_mlss.pl \
    --method_link_type ENSEMBL_ORTHOLOGUES \
    --reg_conf $REG_FILE \
    --collection pan \
    --compara $MASTER_URL \
    --source ensembl \
    --pw --f \
    --release $ENS_VERSION \
    1> ENSEMBL_ORTHOLOGUES.out


# Paralogs
perl $COMPATH/create_mlss.pl \
    --method_link_type ENSEMBL_PARALOGUES \
    --reg_conf $REG_FILE \
    --collection pan \
    --compara $MASTER_URL \
    --source ensembl \
    --sg --f \
    --release $ENS_VERSION \
    1> ENSEMBL_PARALOGUES.out

# Trees
perl $COMPATH/create_mlss.pl \ 
    --method_link_type PROTEIN_TREES \
    --reg_conf $REG_FILE \
    --collection pan \
    --compara $MASTER_URL \
    --source ensembl \
    --name protein_tree_pan_eg${EG_VERSION} \
    --f \
    --release $ENS_VERSION \
    1> PROTEIN_TREES.out

# store MLSS id for this Compara job
mlss_id=`perl -lne 'if(/MethodLinkSpeciesSet has dbID: (\d+)/){ print $1 }' PROTEIN_TREES.out` 
echo $mlss_id

## Load Members, this queries the production server ($PROD_CMD) ############################

# not used: -curr_core_sources_locs '' -prev_core_sources_locs '' -pipeline_dir $comptmp
# note than $USER is added to db name by init script

hive_db_name=${USER}_pan_load_members_${ENS_VERSION}
hive_url=$HIVE_URL$hive_db_name

perl $HIVEPATH/init_pipeline.pl \
  Bio::EnsEMBL::Compara::PipeConfig::EBI::EG::LoadMembers_conf \
  $($HIVE_CMD details hive) \
  -collection pan \
  -division pan \
  -curr_core_registry $REG_FILE \
  -master_db $MASTER_URL \
  -reuse_member_db 0 \
  -hive_force_init 1

echo $hive_url

url="${hive_url};reconnect_when_lost=1"

beekeeper.pl -url $url -sync
runWorker.pl -url $url -reg_conf $REG_FILE
beekeeper.pl -url $url -reg_conf $REG_FILE -loop

# This will fail; open guiHive, type $hive_url, in analysis 'check_versions_match' set 'manual_ok' to 1 and reset as READY
beekeeper.pl -url $url -sync
runWorker.pl -url $url -reg_conf $REG_FILE

# Some species fail:
# i) load_genomedb_factory : due to metadata, such as assembly or strain name, not matching the values in $MASTER_DB
# ii) load_fresh_members_from_db : "MSG: start must be <= end"
# They'll need to be removed (removed_species.txt) or updated with update_genome.pl (metadata_updated_species.txt) and re-run 

## compute ProteinTrees ######################################################################

# not used: -production_db_url $PROD_URL -curr_core_registry $REG_FILE -store_goc_capacity 100  

# member db created in previous step, should be removed after completion
MEMBER_URL=${HIVE_URL}$hive_db_name

compara_db_name=ensembl_compara_pan_hom_${EG_VERSION}_${ENS_VERSION}
compara_url=$HIVE_URL$compara_db_name

perl $HIVEPATH/init_pipeline.pl \
  Bio::EnsEMBL::Compara::PipeConfig::EBI::EG::ProteinTrees_conf \
  $($HIVE_CMD details hive) \
  -division pan \
  -mlss_id $mlss_id \
  -ensembl_release $ENS_VERSION \
  -eg_release $EG_VERSION \
  -member_db $MEMBER_URL \
  -master_db $MASTER_URL \
  -ncbi_db $NCBI_URL \
  -goc_threshold 25 \
  -cdhit_identity_threshold 0.99 \
  -blastp_capacity 420 \
  -hive_force_init 1

echo $compara_url

url="${compara_url};reconnect_when_lost=1"

beekeeper.pl -url $url -sync
runWorker.pl -url $url -reg_conf $REG_FILE
beekeeper.pl -url $url -reg_conf $REG_FILE -loop

# This will fail; open guiHive, type $hive_url, 
# in 'backbone_fire_clustering' and 'check_member_db_is_same_version' set 'manual_ok' to 1 and reset as READY
beekeeper.pl -url $url -sync
runWorker.pl -url $url -reg_conf $REG_FILE

# trouble-shooting

# error in analysis 'genome_member_copy' : Cannot add or update a child row: a foreign key constraint fails 
#    (ensembl_compara_pan_hom_44_97.gene_member, CONSTRAINT gene_member_ibfk_3 FOREIGN KEY (dnafrag_id) 
#    REFERENCES dnafrag (dnafrag_id)), when using table: gene_member
#
# that seems like gene_member is pointing at a dnafrag_id that does not exist.
#
# in guiHive I see its genome_db_id = 2713 (chondrus_crispus)
# then in the `bcontreras_pan_load_members_97` I do
# select count(distinct(dnafrag_id)) from gene_member where genome_db_id = 2713
#657
# select count(distinct(dnafrag_id)) from dnafrag where genome_db_id = 2713
#926
# -> add to updated_species.txt (still same error)
#
# Don't really know what's going on, genes seem to point in all cases to valid seq_region_ids (dnafrag_ids)
# I do see that coord_system for cp genes is different to the rest ?!
#
# eventually removed it as there are two other Rodophitae (Galdieria sulphuraria, Cyanidioschyzon merolae)
# -> removed_species.txt

# 1 out of 780 'blastp_unannotated_himem' analyses failed several times with diverse errors (seems to be a 2Gb_6_hour_job resource)
# it is job_id 18911
beekeeper.pl -url $url -analyses_pattern blastp_unannotated_himem -reset_failed_jobs
#select * from resource_usage_stats where analysis rlike 'blastp_unannotated_himem'
#select * from log_message where job_id = 18911
#'GarbageCollector: The worker died because of RUNLIMIT', 'WORKER_ERROR'
#'Can''t use an undefined value as an ARRAY reference at /nfs/panda/ensemblgenomes/development/bcontreras//compara/97/ensembl-compara/modules/Bio/EnsEMBL/Compara/Utils/Cigars.pm line 320, <BLASTTABLE> line 1470.'
#'GarbageCollector: The worker died because of UNKNOWN'
# so I now run it interactively:
bshell4 -> ebi6-283
screen -S compara1
runWorker.pl -url "mysql://ensrw:scr1b3hive@mysql-ens-hive-prod-2:4411/ensembl_compara_pan_hom_44_97;reconnect_when_lost=1" -job_id 18911 -no_cleanup
#...
#Use of uninitialized value in hash element at /nfs/panda/ensemblgenomes/development/bcontreras//compara/97/ensembl-compara/modules/Bio/EnsEMBL/Compara/DBSQL/PeptideAlignFeatureAdaptor.pm line 327.
#Worker 5090 [ Role 5001 , blastp_unannotated_himem(53) ] Job 18911 : complete
#Worker 5090 [ Role 5001 , blastp_unannotated_himem(53) ] Having completed 1 jobs the Worker exits : JOB_LIMIT
exit

beekeeper.pl -url $url -sync
beekeeper.pl -url $url -reg_conf $REG_FILE --balance_semaphores
runWorker.pl -url $url -reg_conf $REG_FILE

# 2 out of 187 per_genome_qc analyses failed:
#genome_db_id 2714 has too many orphan genes -> cryptomonas_paramecium_gca_000194455
#genome_db_id 2788 has too many orphan genes -> giardia_lamblia
#edited ensembl-compara/modules/Bio/EnsEMBL/Compara/RunnableDB/GeneTrees/PerGenomeGroupsetQC.pm and re-run
#genome_db_id 2714 has too many orphan genes (260/466) please investigate further.
#genome_db_id 2788 has too many orphan genes (4118/7364)
#commnent out if ( !$self->_is_above_orphan_ratio( $genome_db_id, $ncbi_taxon_adaptor ) ) { and re-run

# then, clusterset_backup & backbone_fire_tree_building semaphores had to be unblocked

## final steps ###############################################################################

# NOTE that the resulting db is called $compara_db_name  and should be renamed to
# ensembl_compara_pan_homology_<eg_release>_<ensembl_release>


